# ARM64 QEMU 
문C블로그 QEMU 에뮬레이션 arm64 참고 <http://jake.dothome.co.kr/qemu/>

여기 내용을 따라 해보기.


```
[    1.593665] thermal thermal_zone0: failed to read out thermal zone (-5)
[    1.596499] bcm2835_thermal 3f212000.thermal: Not able to read trip_temp: -33
[    1.599205] bcm2835_thermal: probe of 3f212000.thermal failed with error -33
[    1.605937] sdhost: log_buf @ (ptrval) (fb850000)
[    1.659411] mmc0: sdhost-bcm2835 loaded - DMA enabled (>1)
[    1.663276] of_cfs_init
[    1.669298] of_cfs_init: OK
[    1.682586] Waiting for root device /dev/vda2...
[    1.708740] mmc0: host does not support reading read-only switch, assuming write-enable
[    1.711720] mmc0: new SDHC card at address 4567
[    1.718174] mmcblk0: mmc0:4567 QEMU! 1.73 GiB
[    1.739608]  mmcblk0: p1 p2

````



#### qemu version
```
$ qemu-arm -version
qemu-arm version 2.11.1(Debian 1:2.11+dfsg-1ubuntu7.26)
Copyright (c) 2003-2017 Fabrice Bellard and the QEMU Project developers

$ qemu-system-arm -version
QEMU emulator version 2.11.1(Debian 1:2.11+dfsg-1ubuntu7.26)
Copyright (c) 2003-2017 Fabrice Bellard and the QEMU Project developers
```

#### 툴체인 버젼 및  PATH 확인
```
$ qemu-arm -version
qemu-arm version 2.11.1(Debian 1:2.11+dfsg-1ubuntu7.26)
Copyright (c) 2003-2017 Fabrice Bellard and the QEMU Project developers
good@good-VirtualBox:~/rpi3$ qemu-system-arm -version
QEMU emulator version 2.11.1(Debian 1:2.11+dfsg-1ubuntu7.26)
Copyright (c) 2003-2017 Fabrice Bellard and the QEMU Project developers
```

##  ext4 파일 시스템 이미지 만들기
local 파일을 이용하여 블럭 디바이스 이미지를 생성하고 ext4 파일 시스템으로 format 한 다음 loop 파일 시스템으로 mount하여 필요한 파일 들을 복사해 넣는다. 

1. 4GB 용량의 파티션 이미지 생성
```
$ dd if=/dev/zero of=rootfs.ext4 bs=1M count=4000
$ mkfs.ext4 -F rootfs.ext4
```
2. loop 디바이스 mount 후 root 파일 이미지 복사
```
$ sudo mount rootfs.ext4 mnt1 -o loop
$ cd mnt1
$ sudo rm -rf lost+found
$ sudo tar xf ../linaro-stretch-developer-20180416-89.tar.gz 
$ ls
binary
$ sudo mv binary/* .
$ sudo rm binary -rf
$ cd ..
$ sudo umount mnt1
```

## 리눅스 OS 이미지에서 필요한 파일 분리

1. 이미지 다운로드
```
$ cd qq2
$ wget https://releases.linaro.org/openembedded/aarch64/15.07/vexpress64-openembedded_lamp-armv8-gcc-4.9_20150725-725.img.gz
$ gzip -d vexpress64-openembedded_lamp-armv8-gcc-4.9_20150725-725.img.gz 
```
2. 이미지 파틴션 및 시작 주소 확인
```
$ fdisk -l vexpress64-openembedded_lamp-armv8-gcc-4.9_20150725-725.img

Disk vexpress64-openembedded_lamp-armv8-gcc-4.9_20150725-725.img : 3221 MB, 3221225472 bytes
255 heads, 63 sectors/track, 391 cylinders, total 6291456 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk identifier: 0xdf9ff8a9
                                                            Device Boot      Start         End      Blocks   Id  System
vexpress64-openembedded_lamp-armv8-gcc-4.9_20150725-725.img1   *                63      155646       77792    e  W95 FAT16 (LBA)         <- (offset=63 * 512 = 32256 )
vexpress64-openembedded_lamp-armv8-gcc-4.9_20150725-725.img2                155648     6291455     3067904   83  Linux                   <- (offset=155648 * 512 = 79691776 )
```
3. 이미지 mount
```
$ mkdir mnt1
$ mkdir mnt2

$ sudo mount -v -o offset=32256    -t vfat vexpress64-openembedded_lamp-armv8-gcc-4.9_20150725-725.img mnt1
$ sudo mount -v -o offset=79691776 -t ext4 vexpress64-openembedded_lamp-armv8-gcc-4.9_20150725-725.img mnt2
$ ls mnt2 
bin boot dev EFI etc home lib lost+found media mnt opt proc run sbin sys tmp usr var
$ cd ..
$ sudo umount mnt1
$ sudo umount mnt2
```