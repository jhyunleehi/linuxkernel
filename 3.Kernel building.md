# kernel building

## local building

kernel source 
```
$ uname -a
Linux good-VirtualBox 5.3.0-59-generic #53~18.04.1-Ubuntu SMP Thu Jun 4 14:58:26 UTC 2020 x86_64 
x86_64 x86_64 GNU/Linux
$ sudo apt install git bc bison flex libssl-dev make
$ git clone --depth=1 --branch <branch> https://github.com/raspberrypi/linux
$ git clone --depth=1 --branch rpi-4.19.y https://github.com/raspberrypi/linux
```

Raspberry Pi4 default build configuration
```
$ cd linux
$ KERNEL=kernel7
$make bcm2711_defconfig
```
x86에서 bcm2709 config 오류
```
good@good-VirtualBox:~/kernel/linux$ make bcm2709_defconfig
***
*** Can't find default configuration "arch/x86/configs/bcm2709_defconfig"!
***
scripts/kconfig/Makefile:104: recipe for target 'bcm2709_defconfig' failed
make[1]: *** [bcm2709_defconfig] Error 1
Makefile:534: recipe for target 'bcm2709_defconfig' failed
make: *** [bcm2709_defconfig] Error 
```

Building

```
make -j4 zImage modules dtbs
sudo make modules_install
sudo cp arch/arm/boot/dts/*.dtb /boot/
sudo cp arch/arm/boot/dts/overlays/*.dtb* /boot/overlays/
sudo cp arch/arm/boot/dts/overlays/README /boot/overlays/
sudo cp arch/arm/boot/zImage /boot/$KERNEL.img
```

## Cross-Compiling

1. Install Required dependencies

```
$ sudo apt install git bc bison flex libssl-dev make libc6-dev libncurses5-dev
```
2. Install toolchain


```
$ git clone https://github.com/raspberrypi/tools ~/tools
'/home/good/tools'에 복제합니다...
$ echo PATH=\$PATH:~/tools/arm-bcm2708/arm-linux-gnueabihf/bin >> ~/.bashrc
$ echo export KERNEL=kernel7 >> ~/.bashrc
$ source ~/.bashrc
```


3. get sources
```
$ git clone --depth=1 --branch rpi-4.19.y https://github.com/raspberrypi/linux
```

4. Build sources : bcm2709
```
$ cd linux
$ KERNEL=kernel
# For Pi 1, Pi Zero, Pi Zero W, or Compute Module:
$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bcmrpi_defconfig 
# For Pi 2, Pi 3, Pi 3+, or Compute Module 3:
$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bcm2709_defconfig
# For Raspberry Pi 4:
$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bcm2711_defconfig
# all platform
$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- zImage modules dtbs
```
 5. Install on to SD card

 ```
 # lsblk
 sdb
   sdb1  boot FAT boot partition
   sdb2  ext4 filesystem

# mkdir mnt
# mkdir mnt/fat32
# mkdir mnt/ext4
# sudo mount /dev/sdb1 mnt/fat32
# sudo mount /dev/sdb2 mnt/ext4

# export PATH=\$PATH:~/tools/arm-bcm2708/arm-linux-gnueabihf/bin
# echo export KERNEL=kernel7
# make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- INSTALL_MOD_PATH=mnt/ext4 modules_install

$ sudo cp mnt/fat32/$KERNEL.img mnt/fat32/$KERNEL-backup.img
$ sudo cp arch/arm/boot/zImage mnt/fat32/$KERNEL.img
$ sudo cp arch/arm/boot/dts/*.dtb mnt/fat32/
$ sudo cp arch/arm/boot/dts/overlays/*.dtb* mnt/fat32/overlays/
$ sudo cp arch/arm/boot/dts/overlays/README mnt/fat32/overlays/
$ sudo umount mnt/fat32
$ sudo umount mnt/ext4
```
