# raspi2
## 1. QEMU 설치

참고 : 송원식 iamroot 항목 참고, QEMU를 이용한 라즈베리파이2 커널 디버깅
<http://www.iamroot.org/xe/index.php?mid=Knowledge&search_target=title_content&search_keyword=qemu&document_srl=186059>


### 소스 받기
```
$ mkdir -p ~/code/pi2
$ cd ~/code/pi2

$ git clone https://github.com/0xabu/qemu.git -b raspi
$ cd qemu
$ git submodule update --init dtc
```
 hw/arm/boo.c base 주소 수정

```
#define KERNEL_LOAD_ADDR 0x00008000
```

```
$ sudo apt-get install build-essential libglib2.0-dev zlib1g-dev libpixman-1-dev
$ cd ~/git/pi2/qemu

$ ./configure --target-list=arm-softmmu
$ make -j$(nproc)
$ sudo make install
```
## 2. rpi compile, tool chain

### 커널 4.0.4 버젼 
```
$ sudo apt install git bc bison flex libssl-dev make
$ git clone --depth=1 --branch tag5 https://github.com/raspberrypi/linux  //
$ git clone --depth=1 --branch rpi-4.19.y https://github.com/raspberrypi/linux  // no
```
### 툴체인 구성, 환경 설정
```
$ git clone https://github.com/raspberrypi/tools

#!/bin/sh
export PATH=~/code/pi2/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin:$PATH
export KERNEL=kernel7
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-
```
### build 

* bcm2709_defconfig
```
$ cat ~/code/pi2/linux/build.sh
#!/bin/sh
export PATH=~/code/pi2/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin:$PATH
export KERNEL=kernel7
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-
make  ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bcm2709_defconfig
make  ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- menuconfig 
make  ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- bzImage modules dtbs  -j$(nproc)
scripts/mkknlimg arch/arm/boot/zImage ~/code/pi2/kernel7.img
cp arch/arm/boot/dts/bcm2709-rpi-2-b.dtb ~/code/pi2

# menu config
Kernel hacking --> Compile-time checks and compiler option --> 
            Compile the kernel with debug info --> Enable
            Generate dwarf4 debuginfo --> Enable
            Provide GDB scripts for kernel debuffing--> Enable
```


## 3. 커널, DTB

```
$ scripts/mkknlimg arch/arm/boot/zImage ~/code/pi2/kernel7.img
Version: Linux version 4.0.4-v7 (good@good-VirtualBox) (gcc version 4.9.3 (crosstool-NG crosstool-ng-1.22.0-88-g8460611) ) #1 SMP PREEMPT Mon Jul 6 23:06:16 KST 2020
DT: y
283x: n
$ cp arch/arm/boot/dts/bcm2709-rpi-2-b.dtb ~/code/pi2
```

### run.sh
```
#!/bin/sh
export PATH=~/code/pi2/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin:$PATH
export KERNEL=kernel7
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-

BOOT_CMDLINE="rw earlyprintk loglevel=8 console=ttyAMA0,115200 console=tty1 dwc_otg.lpm_enable=0 root=/dev/mmcblk0p2"
DTB_FILE="bcm2709-rpi-2-b.dtb"
KERNEL_IMG="kernel7.img"
SD_IMG="2015-11-21-raspbian-jessie.img"

echo "target remote localhost:1234"
qemu-system-arm -s -S \
    -M raspi2 \
    -kernel ${KERNEL_IMG} \
    -sd ${SD_IMG} \
    -append "${BOOT_CMDLINE}" \
    -dtb ${DTB_FILE} \
    -serial stdio 

$ netstat -na | grep LISTEN
tcp        0      0 0.0.0.0:1234            0.0.0.0:*               LISTEN     
tcp        0      0 127.0.0.1:5900          0.0.0.0:*               LISTEN     
tcp6       0      0 :::1234                 :::*                    LISTEN     


QEMU_PID=$!
sleep 1
arm-linux-gnueabihf-gdb -ex "target remote localhost:1234" ~/code/pi2/linux/vmlinux

kill -9 ${QEMU_PID}
```
여기서 실행해보면 실제 바로 stop 상태가 되는데 그것은 디버깅을 위해서 -s -S  옶션 때문이다.
일단 정상적인 booting을 위해서는 아래 옵션을 빼고서 실행을 해본다.
```
-S              freeze CPU at startup (use 'c' to start execution)
-s              shorthand for -gdb tcp::1234
```

unable to mount root fs on unknown-block(0,0) 메세지 나오면서 kernel panic  현상
```
[    2.043141] ---[ end Kernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(0,0) ]---
```
일단 boot img 파일을 파일 시스템으로  mount  해서...
```
$ sudo mount -v -o offset=4194304 -t vfat 2020-02-13-raspbian-buster.img  mnt1
```
살펴보면 
cmdline 파일
```
console=serial0,115200 console=tty1 root=PARTUUID=ea7d04d6-02 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait quiet init=/usr/lib/raspi-config/init_resize.sh splash plymouth.ignore-serial-consoles
```

```
$ sudo umount mnt1 
$ sudo mount  -v -o offset=272629760 -t ext4  2020-02-13-raspbian-buster.img  mnt2
mount: /dev/loop18 mounted on /mnt/code/pi2/mnt2.
```

```
$ ls -l ~/code/pi2/mnt2/usr/lib/raspi-config/init_resize.sh 
-rwxr-xr-x 1 root root 4964  1월 10 00:22 init_resize.sh
```

```
$ ddd --debugger arm-linux-gnueabihf-gdb ./vmlinux
# GDB shell에서 target remote localhost:1234 명령을 친다.
(gdb) target remote localhost:1234

# start_kernel 에 브레이크 포인트 셋팅
(gdb) b start_kernel

# 디버깅 시작.
(gdb) c
```


ddd  초기화 
```
drwxr-xr-x 23 good good  4096  7월  7 00:36 .
drwxr-xr-x  3 root root  4096  6월 17 22:21 ..
drwx------ 13 good good  4096  6월 27 18:15 .config
drwx------  4 good good  4096  7월  7 00:37 .ddd

good@good-VirtualBox:~$ rm -rf .ddd

```


#### qemu.run.sh
```
$ cat qrun.sh 
#!/bin/sh
export PATH=~/code/pi2/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin:$PATH
export KERNEL=kernel7
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-

BOOT_CMDLINE="rw earlyprintk loglevel=8 console=ttyAMA0,115200 console=tty1 dwc_otg.lpm_enable=0 root=/dev/mmcblk0p2"
DTB_FILE="bcm2709-rpi-2-b.dtb"
KERNEL_IMG="kernel7.img"
SD_IMG="2015-11-21-raspbian-jessie.img"

echo "target remote localhost:1234"
qemu-system-arm -s -S \
    -M raspi2 \
    -kernel ${KERNEL_IMG} \
    -sd ${SD_IMG} \
    -append "${BOOT_CMDLINE}" \
    -dtb ${DTB_FILE} \
    -serial stdio 
```
#### ddd.sh
```
$ cat ddd.sh
#!/bin/sh
export PATH=~/code/pi2/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin:$PATH
export KERNEL=kernel7
export ARCH=arm
export CROSS_COMPILE=arm-linux-gnueabihf-
ddd --debugger arm-linux-gnueabihf-gdb ./linux/vmlinux
```

